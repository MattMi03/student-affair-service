<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.qhjy.statuschange.mapper.StatusChangeMapper">


    <resultMap id="basicInfo" type="edu.qhjy.statuschange.vo.StudentBasicInfoVO">
        <result column="xm" property="xm"/>
        <result column="csrq" property="csrq"/>
        <result column="sfzjh" property="sfzjh"/>
        <result column="xxmc" property="xxmc"/>
        <result column="bjmc" property="bjmc"/>
        <result column="jdnj" property="jdnj"/>
        <result column="zbmc" property="zbmc"/>
        <result column="mz" property="mz"/>
        <result column="xb" property="xb"/>
    </resultMap>

    <select id="getBasicInfoByKsh" parameterType="edu.qhjy.statuschange.dto.BasicInfoQueryDTO" resultMap="basicInfo">
        SELECT
        ks.KSH AS ksh,
        ks.KJZTMC AS kjztmc,
        ks.XM AS xm, -- ÂßìÂêç
        ks.XB AS xb, -- ÊÄßÂà´
        ks.CSRQ AS csrq, -- Âá∫ÁîüÊó•Êúü
        ks.SFZJH AS sfzjh, -- Ë∫´‰ªΩËØÅÂè∑
        ks.MZ AS mz, -- Ê∞ëÊóè
        school.MC AS xxmc, -- Â≠¶Ê†°ÂêçÁß∞
        ks.BJMC AS bjmc, -- Áè≠Á∫ßÂêçÁß∞
        CONCAT(szs.MC, ' ', kq.MC) AS zbmc, -- ÊãõÂäûÂêçÁß∞ÔºàÂú∞Â∏Ç + ËÄÉÂå∫Ôºâ
        ks.JB AS jdnj
        FROM KSXX ks
        LEFT JOIN XYZDK school ON ks.XXDM = school.DM AND school.JH = 'ZX' -- Â≠¶Ê†°
        LEFT JOIN XYZDK kq ON ks.XXDM LIKE kq.DM || '%' AND kq.JH = 'KD' -- ËÄÉÂå∫
        LEFT JOIN XYZDK szs ON ks.XXDM LIKE szs.DM || '%' AND szs.JH = 'KQ' -- Âú∞Â∏Ç
        <where>
            <if test="permissionDm != null and permissionDm != '' and permissionDm != 'qhs'">
                AND ks.XXDM LIKE CONCAT(#{permissionDm}, '%')
            </if>
            <if test="ksh != null and ksh != ''">
                AND ks.KSH = #{ksh}
            </if>
            <if test="xm != null and xm != ''">
                AND ks.XM LIKE CONCAT('%', #{xm}, '%')
            </if>
            <if test="sfzjh != null and sfzjh != ''">
                AND ks.SFZJH = #{sfzjh}
            </if>
        </where>
    </select>

    <resultMap id="LateRegistrationListResultMap" type="edu.qhjy.statuschange.vo.LateRegistrationListVO">
        <id column="kjydjlbs" property="kjydjlbs"/>
        <result column="ksh" property="ksh"/>
        <result column="xm" property="xm"/>
        <result column="sfzjh" property="sfzjh"/>
        <result column="jb" property="jb"/>
        <result column="bjmc" property="bjmc"/>
        <result column="blsj" property="blsj"/>
        <result column="blxx" property="blxx"/>
        <result column="shzt" property="shzt"/>
        <result column="shyj" property="shyj"/>
        <result column="zbmc" property="zbmc"/>
        <result column="mz" property="mz"/>
        <result column="xb" property="xb"/>
    </resultMap>

    <!-- „ÄêÊñ∞Â¢û„ÄëÊü•ËØ¢Êñ∞ÁîüË°•ÂΩïÂàóË°® -->
    <select id="selectLateRegistrationList" parameterType="edu.qhjy.statuschange.dto.CommonQueryDTO"
            resultMap="LateRegistrationListResultMap">
        SELECT
        j.KJYDJLBS AS kjydjlbs,
        j.KSH AS ksh,
        j.XM AS xm,
        j.SFZJH AS sfzjh,
        ks.jb AS jb,
        ks.BJMC AS bjmc,
        j.CJSJ AS blsj,
        ks.XXMC AS blxx,
        j.SHZT AS shzt, j.SHJD AS shjd, ks.KSLX AS kslx, j.SHSJ AS shsj, j.SHRXM AS shrxm,
        j.SHYJ AS shyj,
        j.ZBMC AS zbmc,
        j.MZ AS mz,
        j.XB AS xb
        FROM
        kjydjl j
        -- ‰ΩøÁî® INNER JOIN ÂÖ≥ËÅî ksxx Ë°®ÔºåÁ°Æ‰øùÂè™Êü•ËØ¢Âá∫Ë°•ÂΩïÁöÑÂ≠¶Áîü
        INNER JOIN ksxx ks ON j.KJYDJLBS = ks.KJYDJLBS
        <where>
            <if test="permissionDm != null and permissionDm != '' and permissionDm != 'qhs'">
                AND ks.XXDM LIKE CONCAT(#{permissionDm}, '%')
            </if>
            -- Ê†∏ÂøÉÁ≠õÈÄâÔºöÂè™Êü•ËØ¢Á±ªÂûã‰∏∫‚ÄúÊñ∞ÁîüË°•ÂΩï‚ÄùÁöÑËÆ∞ÂΩï
            j.KJYDLXBS = 6

            <!-- ÂÖ∂‰ªñÈÄöÁî®Á≠õÈÄâÊù°‰ª∂ -->
            <if test="ksh != null and ksh != ''">AND j.KSH = #{ksh}</if>
            <if test="sfzjh != null and sfzjh != ''">AND j.SFZJH = #{sfzjh}</if>
            <if test="xm != null and xm != ''">AND j.XM LIKE CONCAT('%', #{xm}, '%')</if>
        </where>
        ORDER BY j.CJSJ DESC
    </select>

    <resultMap id="LeaveAuditListResultMap" type="edu.qhjy.statuschange.vo.LeaveAuditListVO">
        <id column="kjydjlbs" property="kjydjlbs"/>
        <result column="ksh" property="ksh"/>
        <result column="xm" property="xm"/>
        <result column="xb" property="xb"/>
        <result column="mz" property="mz"/>
        <result column="sfzjh" property="sfzjh"/>
        <result column="jb" property="jb"/>
        <result column="bjmc" property="bjmc"/>
        <result column="xxrq" property="xxrq"/>
        <result column="xxsc" property="xxsc"/>
        <result column="xxyy" property="xxyy"/>
        <result column="tjsj" property="tjsj"/>
        <result column="shzt" property="shzt"/>
        <result column="shyj" property="shyj"/>
        <result column="xxmc" property="xxmc"/>
        <result column="jdnj" property="jdnj"/>
        <result column="zbmc" property="zbmc"/>
        <result column="yyzmwjdz" property="yyzmwjdz"/>
    </resultMap>

    <!-- Êü•ËØ¢‰ºëÂ≠¶ÂÆ°Ê†∏ÂàóË°® -->
    <select id="getSuspension" parameterType="edu.qhjy.statuschange.dto.CommonQueryDTO"
            resultMap="LeaveAuditListResultMap">
        SELECT
        j.KJYDJLBS AS kjydjlbs,
        j.KSH AS ksh,
        j.XM AS xm,
        j.XB AS xb,
        j.MZ AS mz,
        j.SFZJH AS sfzjh,
        j.CJSJ AS tjsj,
        j.SHZT AS shzt, j.SHJD AS shjd, ks.KSLX AS kslx, 
        j.SHYJ AS shyj,
        j.ZBMC AS zbmc,
        j.SHRXM AS shrxm,
        j.shsj AS shsj,

        -- ‰ªé xfxjl (‰ºëÂ≠¶ÂàÜË°®) Ëé∑Âèñ
        x.XXYY AS xxyy,
        x.XXRQ AS xxrq,
        x.JDNJ AS jdnj,
        x.XXMC AS xxmc,
        x.YYZMWJDZ AS yyzmwjdz,
        x.XXSC AS xxsc,
        ks.jb AS jb,
        ks.BJMC AS bjmc

        FROM
        kjydjl j
        -- ÂÖ≥ËÅî‰ºëÂ≠¶ËØ¶ÊÉÖË°®
        LEFT JOIN xfxjl x ON j.KJYDJLBS = x.KJYDJLBS
        -- ‰∏∫‰∫ÜËé∑ÂèñÁ∫ßÂà´ÂíåÁè≠Á∫ßÂêçÁß∞ÔºåÈúÄË¶ÅÂÖ≥ËÅîÂ≠¶ÁîüË°®ÂíåÁè≠Á∫ßË°®
        LEFT JOIN ksxx ks ON j.KSH = ks.KSH
        WHERE

        -- Á≠õÈÄâÂá∫ÊâÄÊúâ‰ºëÂ≠¶Áî≥ËØ∑
        j.KJYDLXBS = 1
        AND x.XFXBJ = 0
        <if test="permissionDm != null and permissionDm != '' and permissionDm != 'qhs'">
            AND ks.XXDM LIKE CONCAT(#{permissionDm}, '%')
        </if>
        <if test="ksh != null and ksh != ''">
            AND j.KSH = #{ksh}
        </if>
        <if test="xm != null and xm != ''">
            AND j.XM LIKE CONCAT('%', #{xm}, '%')
        </if>
        <if test="sfzjh != null and sfzjh != ''">
            AND j.SFZJH = #{sfzjh}
        </if>
        ORDER BY
        j.CJSJ DESC
    </select>

    <select id="getLatestXfxjlByKjydjlbs" parameterType="java.lang.String"
            resultType="edu.qhjy.statuschange.domain.Xfxjl">
        SELECT *
        FROM xfxjl xfx
                 LEFT JOIN kjydjl jd ON xfx.KJYDJLBS = jd.KJYDJLBS
        WHERE jd.KSH = #{ksh}
        ORDER BY KJYDLXBS DESC
        LIMIT 1
    </select>

    <resultMap id="ReturnAuditListResultMap" type="edu.qhjy.statuschange.vo.ReturnAuditListVO">
        <result column="kjydjlbs" property="kjydjlbs"/>
        <result column="ksh" property="ksh"/>
        <result column="xm" property="xm"/>
        <result column="xb" property="xb"/>
        <result column="mz" property="mz"/>
        <result column="sfzjh" property="sfzjh"/>
        <result column="zbmc" property="zbmc"/>
        <result column="fxlx" property="fxlx"/>
        <result column="xxyy" property="xxyy"/>
        <result column="xxrq" property="xxrq"/>
        <result column="fxrq" property="fxrq"/>
        <result column="xxsc" property="xxsc"/>
        <result column="fxxjh" property="fxxjh"/>
        <result column="xbjmc" property="xbjmc"/>
        <result column="xxmc" property="xxmc"/>
        <result column="jdnj" property="jdnj"/>
        <result column="xjdnj" property="xjdnj"/>
        <result column="bz" property="bz"/>
        <result column="cjsj" property="cjsj"/>
        <result column="shzt" property="shzt"/>
        <result column="shyj" property="shyj"/>
        <result column="yyzmwjdz" property="yyzmwjdz"/>
    </resultMap>

    <select id="selectReturnList" parameterType="edu.qhjy.statuschange.dto.CommonQueryDTO"
            resultMap="ReturnAuditListResultMap">
        SELECT
        j.KJYDJLBS AS kjydjlbs,
        j.KSH AS ksh,
        j.XM AS xm,
        j.XB AS xb,
        j.MZ AS mz,
        j.SFZJH AS sfzjh,
        j.CJSJ AS cjsj,
        j.SHZT AS shzt,
        j.SHJD AS shjd, ks.KSLX AS kslx, 
        j.SHYJ AS shyj,
        j.ZBMC AS zbmc,
        j.SHRXM AS shrxm,
        j.shsj AS shsj,
        x.XXMC AS xxmc, -- ‰ºëÂ≠¶ÂêçÁß∞
        x.jdnj AS jdnj, -- Á∫ßÂà´Âπ¥Á∫ß
        x.XXYY AS xxyy, -- ‰ºëÂ≠¶ÂéüÂõ†
        'Â§çÂ≠¶' AS fxlx, -- ÂèØ‰ª•ÂÜôÊ≠ªÔºå‰πüÂèØ‰ª•Â≠óÂÖ∏ÂÖ≥ËÅî
        x.XXRQ AS xxrq, -- ‰ºëÂ≠¶Êó•Êúü
        x.FXRQ AS fxrq, -- Â§çÂ≠¶Êó•Êúü
        x.XBJMC AS xbjmc, -- Êñ∞Áè≠Á∫ß
        x.XJDNJ AS xjdnj, -- Á∫ßÂà´Âπ¥Á∫ß
        x.yyzmwjdz AS yyzmwjdz, -- ÂéüÂõ†ËØÅÊòéÊñá‰ª∂Âú∞ÂùÄ
        x.XXSC AS xxsc,
        x.FXXJH AS fxxjh, -- Â§çÂ≠¶Â≠¶Á±çÂè∑
        x.BZ AS bz -- Â§áÊ≥®
        FROM
        kjydjl j
        INNER JOIN xfxjl x ON j.KJYDJLBS = x.KJYDJLBS
        LEFT JOIN ksxx ks ON j.KSH = ks.KSH   <!-- üëà ÊääÂ≠¶ÁîüË°®Ëøû‰∏ä -->
        <where>
            j.KJYDLXBS = 2
            AND x.XFXBJ = 1
            <if test="permissionDm != null and permissionDm != '' and permissionDm != 'qhs'">
                AND ks.XXDM LIKE CONCAT(#{permissionDm}, '%')
            </if>
            <if test="ksh != null and ksh != ''">
                AND j.KSH = #{ksh}
            </if>
            <if test="xm != null and xm != ''">
                AND j.XM LIKE CONCAT('%', #{xm}, '%')
            </if>
            <if test="sfzjh != null and sfzjh != ''">
                AND j.SFZJH = #{sfzjh}
            </if>
        </where>
        ORDER BY j.CJSJ DESC
    </select>

    <update id="updateXfxjlDetails" parameterType="edu.qhjy.statuschange.domain.Xfxjl">
        UPDATE xfxjl
        SET XBJMC = #{xbjmc},
            XBJBS = #{xbjbs},
            XJDNJ = #{xjdnj}
        WHERE XFXJLBS = #{xfxjlbs}
    </update>

    <insert id="insertXfxjl" parameterType="edu.qhjy.statuschange.domain.Xfxjl">
        INSERT INTO xfxjl
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="kjydjlbs != null">KJYDJLBS,</if>
            <if test="xfxbj != null">XFXBJ,</if>
            <if test="xxyy != null">XXYY,</if>
            <if test="xxrq != null">XXRQ,</if>
            <if test="xxsc != null">XXSC,</if>
            <if test="xxmc != null">XXMC,</if>
            <if test="jdnj != null">JDNJ,</if>
            <if test="fxxjh != null">FXXJH,</if>
            <if test="fxrq != null">FXRQ,</if>
            <if test="xbjmc != null">XBJMC,</if>
            <if test="xjdnj != null">XJDNJ,</if>
            <if test="bz != null">BZ,</if>
            <if test="yyzmwjdz != null">YYZMWJDZ,</if>
            <if test="cjrxm != null">CJRXM,</if>
            <if test="cjrgzrym != null">CJRGZRYM,</if>
            <if test="cjsj != null">CJSJ,</if>
            <if test="gxrxm != null">GXRXM,</if>
            <if test="gxrgzrym != null">GXRGZRYM,</if>
            <if test="gxsj != null">GXSJ,</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            <if test="kjydjlbs != null">#{kjydjlbs},</if>
            <if test="xfxbj != null">#{xfxbj},</if>
            <if test="xxyy != null">#{xxyy},</if>
            <if test="xxrq != null">#{xxrq},</if>
            <if test="xxsc != null">#{xxsc},</if>
            <if test="xxmc != null">#{xxmc},</if>
            <if test="jdnj != null">#{jdnj},</if>
            <if test="fxxjh != null">#{fxxjh},</if>
            <if test="fxrq != null">#{fxrq},</if>
            <if test="xbjmc != null">#{xbjmc},</if>
            <if test="xjdnj != null">#{xjdnj},</if>
            <if test="bz != null">#{bz},</if>
            <if test="yyzmwjdz != null">#{yyzmwjdz},</if>
            <if test="cjrxm != null">#{cjrxm},</if>
            <if test="cjrgzrym != null">#{cjrgzrym},</if>
            <if test="cjsj != null">#{cjsj},</if>
            <if test="gxrxm != null">#{gxrxm},</if>
            <if test="gxrgzrym != null">#{gxrgzrym},</if>
            <if test="gxsj != null">#{gxsj},</if>
        </trim>
    </insert>

    <resultMap id="TransferAuditListResultMap" type="edu.qhjy.statuschange.vo.TransferAuditListVO">
        <id column="kjydjlbs" property="kjydjlbs"/>
        <result column="scwjdz" property="scwjdz"/>
        <result column="ksh" property="ksh"/>
        <result column="xm" property="xm"/>
        <result column="sfzjh" property="sfzjh"/>
        <result column="jb" property="jb"/>
        <result column="jdnj" property="jdnj"/>
        <result column="yjdbj" property="yjdbj"/>
        <result column="xxmc" property="xxmc"/>
        <result column="yxxmc" property="yxxmc"/>
        <result column="jdbj" property="jdbj"/>
        <result column="zcsj" property="zcsj"/>
        <result column="zcyy" property="zcyy"/>
        <result column="shzt" property="shzt"/>
        <result column="shyj" property="shyj"/>
        <result column="tjsj" property="tjsj"/>
        <result column="szqmc" property="zrsfmc"/>
        <result column="szsmc" property="zrcsmc"/>
        <result column="szxmc" property="zrqxmc"/>
        <result column="zbmc" property="zbmc"/>
        <result column="mz" property="mz"/>
        <result column="xb" property="xb"/>
    </resultMap>

    <!-- „ÄêÊñ∞Â¢û„ÄëÊü•ËØ¢ËΩ¨Â≠¶ÂÆ°Ê†∏ÂàóË°® -->
    <select id="getTransfer" parameterType="map" resultMap="TransferAuditListResultMap">
        SELECT
        -- ‰ªé kjydjl (ÊÄªË°®) Ëé∑Âèñ
        j.KJYDJLBS AS kjydjlbs,
        j.KSH AS ksh,
        j.XM AS xm,
        j.SFZJH AS sfzjh,
        j.SHZT AS shzt, j.SHJD AS shjd, ks.KSLX AS kslx, 
        j.SHYJ AS shyj,
        j.SHRXM AS shrxm,
        j.SHSJ AS shsj,
        j.CJSJ AS tjsj,
        j.ZBMC AS zbmc,
        j.MZ AS mz,
        j.XB AS xb,

        -- ‰ªé zxjl (ËΩ¨Â≠¶ÂàÜË°®) Ëé∑Âèñ
        z.YXXMC AS yxxmc, -- ÂéüÂ≠¶Ê†°ÂêçÁß∞
        z.XXMC AS xxmc, -- Áé∞Â≠¶Ê†°ÂêçÁß∞
        z.SZQMC as szqmc, -- ÊâÄÂú®ÁúÅÂå∫ÂêçÁß∞
        z.SZSMC as szsmc, -- ÊâÄÂú®ÁúÅÂ∏ÇÂêçÁß∞
        z.SZXMC as szxmc, -- ÊâÄÂú®ÂéøÂå∫ÂêçÁß∞
        z.YJDBJ AS yjdbj, -- ÂéüÂ∞±ËØªÁè≠Á∫ß
        z.JDBJ AS jdbj, -- Áé∞Â∞±ËØªÁè≠Á∫ß
        z.ZCYY AS zcyy, -- ËΩ¨Â≠¶ÂéüÂõ†
        z.JDNJ AS jdnj, -- Á∫ßÂà´Âπ¥Á∫ß
        z.ZCSJ AS zcsj, -- ËΩ¨Â≠¶Êó∂Èó¥
        z.SCWJDZ AS scwjdz,-- ÂÆ°Êü•Êñá‰ª∂Âú∞ÂùÄ
        z.jdsqzmwjdz AS jdsqzmwjdz, -- Â∞±ËØªÁî≥ËØ∑ËØÅÊòéÊñá‰ª∂Âú∞ÂùÄ
        z.mbxxlqzmwjdz AS mbxxlqzmwjdz, -- ÁõÆÊ†áÂ≠¶Ê†°ÂΩïÂèñËØÅÊòéÊñá‰ª∂Âú∞ÂùÄ
        z.swjdsxbawjdz AS swjdsxbawjdz, -- ÁúÅÂ§ñÂ∞±ËØªÊâãÁª≠Â§áÊ°àÊñá‰ª∂Âú∞ÂùÄ
        ks.jb AS jb -- Á∫ßÂà´
        FROM kjydjl j
        INNER JOIN zxjl z ON j.KJYDJLBS = z.KJYDJLBS
        LEFT JOIN ksxx ks ON j.KSH = ks.KSH
        <where>
            j.KJYDLXBS = 4
            <if test="common.permissionDm != null and common.permissionDm != '' and common.permissionDm != 'qhs'">
                AND ks.XXDM LIKE CONCAT(#{common.permissionDm}, '%')
            </if>
            <if test="zxlx != null">
                AND z.ZXLX = #{zxlx}
            </if>
            <if test="common.ksh != null and common.ksh != ''">
                AND j.KSH = #{common.ksh}
            </if>
            <if test="common.xm != null and common.xm != ''">
                AND j.XM LIKE CONCAT('%', #{common.xm}, '%')
            </if>
            <if test="common.sfzjh != null and common.sfzjh != ''">
                AND j.SFZJH = #{common.sfzjh}
            </if>
        </where>
        ORDER BY
        j.CJSJ DESC
    </select>

    <update id="updateZxjlDetails" parameterType="edu.qhjy.statuschange.domain.Zxjl">
        UPDATE zxjl
        SET jdbj = #{jdbj},
            BJBS = #{bjbs}
        WHERE KJYDJLBS = #{kjydjlbs}
    </update>

    <!--    private String jdsqzmwjdz; // Â∞±ËØªÁî≥ËØ∑ËØÅÊòéÊñá‰ª∂Âú∞ÂùÄ-->
    <!--    private String mbxxlqzmwjdz; // ÁõÆÊ†áÂ≠¶Ê†°ÂΩïÂèñËØÅÊòéÊñá‰ª∂Âú∞ÂùÄ-->
    <!--    private String swjdsxbawjdz; // ÁúÅÂ§ñÂ∞±ËØªÊâãÁª≠Â§áÊ°àÊñá‰ª∂Âú∞ÂùÄ-->
    <insert id="insertZxjl" parameterType="edu.qhjy.statuschange.domain.Zxjl">
        INSERT INTO zxjl
        (kjydjlbs, zxlx, yxxmc, yjdbj, xxmc, jdbj, jdnj, zcsj, zcyy, scwjdz, SZSMC, SZQMC, SZXMC, jdsqzmwjdz,
         mbxxlqzmwjdz, swjdsxbawjdz)
        VALUES (#{kjydjlbs}, #{zxlx}, #{yxxmc}, #{yjdbj}, #{xxmc}, #{jdbj}, #{jdnj}, #{zcsj}, #{zcyy}, #{scwjdz},
                #{szsmc}, #{szqmc}, #{szxmc}, #{jdsqzmwjdz}, #{mbxxlqzmwjdz}, #{swjdsxbawjdz})
    </insert>

    <resultMap id="AttritionListResultMap" type="edu.qhjy.statuschange.vo.AttritionListVO">
        <id column="kjydjlbs" property="kjydjlbs"/>
        <result column="ksh" property="ksh"/>
        <result column="xm" property="xm"/>
        <result column="sfzjh" property="sfzjh"/>
        <result column="jb" property="jb"/>
        <result column="bjmc" property="bjmc"/>
        <result column="lsyy" property="lsyy"/>
        <result column="lssj" property="lssj"/>
        <result column="czsj" property="czsj"/>
        <result column="shzt" property="shzt"/>
        <result column="shyj" property="shyj"/>
        <result column="mz" property="mz"/>
        <result column="xb" property="xb"/>
        <result column="zbmc" property="zbmc"/>
    </resultMap>

    <insert id="insertLsjl" parameterType="edu.qhjy.statuschange.domain.Lsjl">
        INSERT INTO lsjl
            (kjydjlbs, lsyy, lssj)
        VALUES (#{kjydjlbs}, #{lsyy}, #{lssj})
    </insert>

    <select id="selectAttritionList" parameterType="edu.qhjy.statuschange.dto.CommonQueryDTO"
            resultMap="AttritionListResultMap">
        SELECT
        j.KJYDJLBS AS kjydjlbs,
        j.KSH AS ksh,
        j.XM AS xm,
        j.SFZJH AS sfzjh,
        ks.jb AS jb,
        ks.BJMC AS bjmc,
        l.LSYY AS lsyy,
        l.LSSJ AS lssj,
        j.CJSJ AS czsj,
        j.SHZT AS shzt, j.SHJD AS shjd, ks.KSLX AS kslx, 
        j.SHYJ AS shyj,
        j.SHRXM AS shrxm,
        j.SHSJ AS shsj,
        j.mz AS mz,
        j.xb AS xb,
        j.zbmc AS zbmc
        FROM
        kjydjl j
        INNER JOIN lsjl l ON j.KJYDJLBS = l.KJYDJLBS
        LEFT JOIN ksxx ks ON j.KSH = ks.KSH
        WHERE
        -- Á≠õÈÄâÂá∫ÊâÄÊúâÊµÅÂ§±Áî≥ËØ∑
        j.KJYDLXBS = 5
        <if test="permissionDm != null and permissionDm != '' and permissionDm != 'qhs'">
            AND ks.XXDM LIKE CONCAT(#{permissionDm}, '%')
        </if>
        <if test="ksh != null and ksh != ''">
            AND j.KSH = #{ksh}
        </if>
        <if test="xm != null and xm != ''">
            AND j.XM LIKE CONCAT('%', #{xm}, '%')
        </if>
        <if test="sfzjh != null and sfzjh != ''">
            AND j.SFZJH = #{sfzjh}
        </if>
        ORDER BY
        j.CJSJ DESC
    </select>

    <resultMap id="AbroadListResultMap" type="edu.qhjy.statuschange.vo.AbroadListVO">
        <id column="cgdjbs" property="cgdjbs"/>
        <result column="ksh" property="ksh"/>
        <result column="xm" property="xm"/>
        <result column="sfzjh" property="sfzjh"/>
        <result column="xxmc" property="xxmc"/>
        <result column="cggj" property="cggj"/>
        <result column="clrxm" property="clrxm"/>
        <result column="djsj" property="djsj"/>
        <result column="cgyy" property="cgyy"/>
        <result column="bz" property="bz"/>
    </resultMap>

    <select id="selectAbroadList" parameterType="edu.qhjy.statuschange.dto.CommonQueryDTO"
            resultMap="AbroadListResultMap">
        SELECT
        c.CGDJBS AS cgdjbs,
        j.KJYDJLBS AS kjydjlbs,
        j.KSH AS ksh,
        j.XM AS xm,
        j.SFZJH AS sfzjh,
        c.XXMC AS xxmc,
        c.CGGJ AS cggj,
        c.CLRXM AS clrxm,
        c.DJSJ AS djsj,
        c.CGYY AS cgyy,
        c.BZ AS bz
        FROM
        kjydjl j
        INNER JOIN cgdj c ON j.KJYDJLBS = c.KJYDJLBS
        WHERE

        j.KJYDLXBS = 7
        <if test="permissionDm != null and permissionDm != '' and permissionDm != 'qhs'">
            AND ks.XXDM LIKE CONCAT(#{permissionDm}, '%')
        </if>
        <if test="ksh != null and ksh != ''">
            AND j.KSH = #{ksh}
        </if>
        <if test="xm != null and xm != ''">
            AND j.XM LIKE CONCAT('%', #{xm}, '%')
        </if>
        <if test="sfzjh != null and sfzjh != ''">
            AND j.SFZJH = #{sfzjh}
        </if>
        ORDER BY
        j.CJSJ DESC
    </select>

    <insert id="insertAbroadRegistration" parameterType="edu.qhjy.statuschange.domain.Cgdj">
        INSERT INTO cgdj
            (xxmc, cggj, clrxm, djsj, cgyy, bz, kjydjlbs)
        VALUES (#{xxmc}, #{cggj}, #{clrxm}, #{djsj}, #{cgyy}, #{bz}, #{kjydjlbs})
    </insert>

    <resultMap id="KeyPropertyChangeListResultMap" type="edu.qhjy.statuschange.vo.KeyPropertyChangeListVO">
        <id column="kjydjlbs" property="kjydjlbs"/>
        <result column="ggsxmc" property="ggsxmc"/>
        <result column="ksh" property="ksh"/>
        <result column="xm" property="xm"/>
        <result column="sfzjh" property="sfzjh"/>
        <result column="gqz" property="gqz"/>
        <result column="ghz" property="ghz"/>
        <result column="czsj" property="czsj"/>
        <result column="shzt" property="shzt"/>
        <result column="shyj" property="shyj"/>
        <result column="zmwjdz" property="zmwjdz"/>
        <result column="jb" property="jb"/>
        <result column="bjmc" property="bjmc"/>
        <result column="zbmc" property="zbmc"/>
        <result column="mz" property="mz"/>
        <result column="xb" property="xb"/>
    </resultMap>

    <insert id="insertKeyPropertyChange" parameterType="edu.qhjy.statuschange.domain.Xxbgjl">
        INSERT INTO xxbgjl
            (kjydjlbs, ggsxmc, gqz, ghz, zmwjdz)
        VALUES (#{kjydjlbs}, #{ggsxmc}, #{gqz}, #{ghz}, #{zmwjdz})
    </insert>

    <select id="selectKeyPropertyChangeList" parameterType="edu.qhjy.statuschange.dto.CommonQueryDTO"
            resultMap="KeyPropertyChangeListResultMap">
        SELECT
        j.KJYDJLBS AS kjydjlbs,
        g.GGSXMC AS ggsxmc,
        j.KSH AS ksh,
        j.XM AS xm,
        j.SFZJH AS sfzjh,
        g.GQZ AS gqz,
        g.GHZ AS ghz,
        j.CJSJ AS czsj,
        j.SHZT AS shzt, j.SHJD AS shjd, ks.KSLX AS kslx, 
        j.SHYJ AS shyj,
        j.SHRXM AS shrxm,
        j.SHSJ AS shsj,
        j.ZBMC AS zbmc,
        j.MZ AS mz,
        j.XB AS xb,
        g.ZMWJDZ AS zmwjdz,
        ks.jb AS jb,
        ks.BJMC AS bjmc
        FROM
        kjydjl j
        INNER JOIN xxbgjl g ON j.KJYDJLBS = g.KJYDJLBS
        LEFT JOIN ksxx ks ON j.KSH = ks.KSH
        WHERE
        j.KJYDLXBS = 3
        <if test="permissionDm != null and permissionDm != '' and permissionDm != 'qhs'">
            AND ks.XXDM LIKE CONCAT(#{permissionDm}, '%')
        </if>
        <if test="ksh != null and ksh != ''">
            AND j.KSH = #{ksh}
        </if>
        <if test="xm != null and xm != ''">
            AND j.XM LIKE CONCAT('%', #{xm}, '%')
        </if>
        <if test="sfzjh != null and sfzjh != ''">
            AND j.SFZJH = #{sfzjh}
        </if>
        ORDER BY
        j.CJSJ DESC
    </select>

    <select id="findIfExistByKsh" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM ksxx
        WHERE KSH = #{ksh}
    </select>

    <insert id="insertKjydjl" parameterType="edu.qhjy.statuschange.domain.Kjydjl" useGeneratedKeys="true"
            keyProperty="kjydjlbs">
        INSERT INTO kjydjl (KSH, XM, XB, MZ, SFZJH, ZBMC, KJYDLXBS, CJSJ, SHZT, SHJD)
        VALUES (#{ksh}, #{xm}, #{xb}, #{mz}, #{sfzjh}, #{zbmc}, #{kjydlxbs}, NOW(), #{shzt}, #{shjd})
    </insert>

    <select id="getKjydlxbsByKjydjlbs" parameterType="java.lang.Long"
            resultType="edu.qhjy.statuschange.dto.delete.KjydjlRecordDTO">
        SELECT KJYDLXBS, SHZT
        FROM kjydjl
        WHERE KJYDJLBS = #{kjydjlbs}
    </select>

    <delete id="deleteXfxjlByKjydjlbs" parameterType="java.lang.Long">
        DELETE
        FROM xfxjl
        WHERE KJYDJLBS = #{kjydjlbs}
    </delete>

    <delete id="deleteZxjlByKjydjlbs" parameterType="java.lang.Long">
        DELETE
        FROM zxjl
        WHERE KJYDJLBS = #{kjydjlbs}
    </delete>

    <delete id="deleteLsjlByKjydjlbs" parameterType="java.lang.Long">
        DELETE
        FROM lsjl
        WHERE KJYDJLBS = #{kjydjlbs}
    </delete>

    <delete id="deleteCgdjByKjydjlbs" parameterType="java.lang.Long">
        DELETE
        FROM cgdj
        WHERE KJYDJLBS = #{kjydjlbs}
    </delete>

    <delete id="deleteXxbgjlByKjydjlbs" parameterType="java.lang.Long">
        DELETE
        FROM xxbgjl
        WHERE KJYDJLBS = #{kjydjlbs}
    </delete>

    <delete id="deleteKjydjlById" parameterType="java.lang.Long">
        DELETE
        FROM kjydjl
        WHERE KJYDJLBS = #{kjydjlbs}
    </delete>

    <resultMap id="InformationChangeSummaryResultMap" type="edu.qhjy.statuschange.vo.InformationChangeSummaryVO">
        <result column="ksh" property="ksh"/>
        <result column="xm" property="xm"/>
        <result column="sfzjh" property="sfzjh"/>
        <result column="jb" property="jb"/>
        <result column="bjmc" property="bjmc"/>
        <result column="keyPropertyChangeCount" property="keyPropertyChangeCount"/>
        <result column="returnSchoolCount" property="returnSchoolCount"/>
        <result column="leaveSchoolCount" property="leaveSchoolCount"/>
        <result column="inProvinceInCount" property="inProvinceInCount"/>
        <result column="inProvinceOutCount" property="inProvinceOutCount"/>
        <result column="outOfProvinceInCount" property="outOfProvinceInCount"/>
        <result column="outOfProvinceOutCount" property="outOfProvinceOutCount"/>
    </resultMap>

    <select id="selectInformationChangeSummary"
            parameterType="edu.qhjy.statuschange.dto.CommonQueryDTO"
            resultMap="InformationChangeSummaryResultMap">

        SELECT
        ks.KSH AS ksh,
        ks.XM AS xm,
        ks.SFZJH AS sfzjh,
        ks.jb AS jb,
        ks.BJMC AS bjmc,

        -- ‰ΩøÁî® COUNT Âíå CASE WHEN ËøõË°åÊù°‰ª∂ËÆ°Êï∞
        COUNT(CASE WHEN j.KJYDLXBS = 3 THEN 1 END) AS keyPropertyChangeCount, -- ÂÖ≥ÈîÆ‰ø°ÊÅØÂèòÊõ¥
        COUNT(CASE WHEN j.KJYDLXBS = 2 AND x.XFXBJ = 1 THEN 1 END) AS returnSchoolCount, -- Â§çÂ≠¶
        COUNT(CASE WHEN j.KJYDLXBS = 1 AND x.XFXBJ = 0 THEN 1 END) AS leaveSchoolCount, -- ‰ºëÂ≠¶

        -- ÁªüËÆ°‰∏çÂêåÂ≠êÁ±ªÂûãÁöÑËΩ¨Â≠¶Ê¨°Êï∞
        COUNT(CASE WHEN z.ZXLX = 2 THEN 1 END) AS inProvinceInCount, -- ÁúÅÂÜÖËΩ¨ÂÖ•
        COUNT(CASE WHEN z.ZXLX = 1 THEN 1 END) AS inProvinceOutCount, -- ÁúÅÂÜÖËΩ¨Âá∫
        COUNT(CASE WHEN z.ZXLX = 4 THEN 1 END) AS outOfProvinceInCount, -- ÁúÅÂ§ñËΩ¨ÂÖ•
        COUNT(CASE WHEN z.ZXLX = 3 THEN 1 END) AS outOfProvinceOutCount -- ËΩ¨Âá∫ÁúÅÂ§ñ

        FROM ksxx ks
        LEFT JOIN kjydjl j ON ks.KSH = j.KSH
        LEFT JOIN xfxjl x ON j.KJYDJLBS = x.KJYDJLBS
        LEFT JOIN zxjl z ON j.KJYDJLBS = z.KJYDJLBS

        <where>
            <if test="permissionDm != null and permissionDm != '' and permissionDm != 'qhs'">
                AND ks.XXDM LIKE CONCAT(#{permissionDm}, '%')
            </if>
            <if test="ksh != null and ksh != ''">
                AND ks.KSH = #{ksh}
            </if>
            <if test="xm != null and xm != ''">
                AND ks.XM LIKE CONCAT('%', #{xm}, '%')
            </if>
            <if test="sfzjh != null and sfzjh != ''">
                AND ks.SFZJH = #{sfzjh}
            </if>
        </where>

        -- ÊåâÂ≠¶ÁîüËøõË°åÂàÜÁªÑ
        GROUP BY ks.KSH, ks.XM, ks.SFZJH, ks.jb, ks.BJMC
        ORDER BY ks.KSH
    </select>


    <resultMap id="selectInformationChangeSummaryBySchoolResultMap"
               type="edu.qhjy.statuschange.vo.InformationChangeSummaryBySchoolVO">
        <result column="xxmc" property="xxmc"/>
        <result column="jb" property="jb"/>
        <result column="kqmc" property="kqmc"/>
        <result column="keyPropertyChangeCount" property="keyPropertyChangeCount"/>
        <result column="returnSchoolCount" property="returnSchoolCount"/>
        <result column="leaveSchoolCount" property="leaveSchoolCount"/>
        <result column="inProvinceInCount" property="inProvinceInCount"/>
        <result column="inProvinceOutCount" property="inProvinceOutCount"/>
        <result column="outOfProvinceInCount" property="outOfProvinceInCount"/>
        <result column="outOfProvinceOutCount" property="outOfProvinceOutCount"/>
    </resultMap>

    <select id="selectInformationChangeSummaryBySchool"
            parameterType="edu.qhjy.statuschange.dto.SummaryQueryDTO"
            resultMap="selectInformationChangeSummaryBySchoolResultMap">

        SELECT
        school.MC AS xxmc, -- Â≠¶Ê†°
        ks.JB AS jb, -- Âπ¥Á∫ß
        kq.MC AS kqmc, -- ËÄÉÂå∫

        COUNT(CASE WHEN j.KJYDLXBS = 3 THEN 1 END) AS keyPropertyChangeCount,
        COUNT(CASE WHEN j.KJYDLXBS = 2 AND x.XFXBJ = 1 THEN 1 END) AS returnSchoolCount,
        COUNT(CASE WHEN j.KJYDLXBS = 1 AND x.XFXBJ = 0 THEN 1 END) AS leaveSchoolCount,

        COUNT(CASE WHEN z.ZXLX = 2 THEN 1 END) AS inProvinceInCount,
        COUNT(CASE WHEN z.ZXLX = 1 THEN 1 END) AS inProvinceOutCount,
        COUNT(CASE WHEN z.ZXLX = 4 THEN 1 END) AS outOfProvinceInCount,
        COUNT(CASE WHEN z.ZXLX = 3 THEN 1 END) AS outOfProvinceOutCount

        FROM KSXX ks
        LEFT JOIN KJYDJL j ON ks.KSH = j.KSH
        LEFT JOIN XFXJL x ON j.KJYDJLBS = x.KJYDJLBS
        LEFT JOIN ZXJL z ON j.KJYDJLBS = z.KJYDJLBS

        -- ‰ΩøÁî®XYZDK‰ª£ÊõøÂéüÊù•ÁöÑÂ≠¶Ê†°ÂíåËÄÉÂå∫Ë°®
        LEFT JOIN XYZDK school ON ks.XXDM = school.DM AND school.JH = 'ZX' -- Â≠¶Ê†°
        LEFT JOIN XYZDK kq ON ks.XXDM LIKE kq.DM || '%' AND kq.JH = 'KD' -- ËÄÉÂå∫

        <where>
            <if test="permissionDm != null and permissionDm != '' and permissionDm != 'qhs'">
                AND ks.XXDM LIKE CONCAT(#{permissionDm}, '%')
            </if>
            <if test="xxdm != null and xxdm != ''">
                AND school.DM = #{xxdm}
            </if>
            <if test="kqdm != null and kqdm != ''">
                AND kq.DM = #{kqdm}
            </if>
            <if test="jb != null">
                AND ks.JB = #{jb}
            </if>
            <if test="szsdm != null and szsdm != ''">
                AND ks.XXDM LIKE #{szsdm} || '%' -- Âú∞Â∏ÇÂèØ‰ª•ÈÄöËøáÂâçÁºÄÂåπÈÖç
            </if>
        </where>

        GROUP BY school.MC, ks.JB, kq.MC
        ORDER BY school.MC, ks.JB DESC
    </select>


    <select id="selectInformationChangeByKsh" resultType="edu.qhjy.statuschange.vo.InformationChangeVO">
        SELECT CONCAT(g.GGSXMC, 'ÂèòÊõ¥‰∏∫', g.GHZ) AS changeItem,
               j.CJRXM                           AS operator,
               j.CJSJ                            AS time,
               0                                 AS status -- Áä∂ÊÄÅÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅËÆæÁΩÆÔºåËøôÈáåÈªòËÆ§‰∏∫0
        FROM kjydjl j
                 JOIN
             xxbgjl g ON j.KJYDJLBS = g.KJYDJLBS
        WHERE j.KSH = #{ksh}
          AND j.KJYDLXBS = 3 -- 3 = ÂÖ≥ÈîÆÂ±ûÊÄß‰øÆÊîπ
        ORDER BY j.CJSJ DESC
    </select>


    <select id="selectStatusChangeByKsh" resultType="edu.qhjy.statuschange.vo.StatusChangeVO">
        SELECT ks.BJMC    AS className,
               j.XM       AS studentName,
               j.CJRXM    AS operator,
               l.KJYDLXMC AS changeItem, -- ‰ªéÂºÇÂä®Á±ªÂûãË°®Ëé∑ÂèñÈ°πÁõÆÂêçÁß∞
               CASE j.KJYDLXBS
                   WHEN 1 THEN CONCAT('Âõ†', x.XXYY, '‰ºëÂ≠¶') -- ‰ºëÂ≠¶
                   WHEN 2 THEN CONCAT('Â≠¶ÁîüÂ§çÂ≠¶ÔºåÁè≠Á∫ßÁî±', x.BJMC, 'Ë∞ÉÊï¥‰∏∫', x.XBJMC) -- Â§çÂ≠¶
                   WHEN 4 THEN CONCAT('‰ªé', z.YXXMC, 'ËΩ¨Â≠¶Ëá≥', z.XXMC) -- ËΩ¨Â≠¶
                   WHEN 5 THEN CONCAT('Âõ†', ls.LSYY, 'ÊµÅÂ§±') -- ÊµÅÂ§±
                   WHEN 6 THEN 'Êñ∞ÁîüÊ≥®ÂÜåÂÖ•Â∫ì'
                   WHEN 7 THEN CONCAT('Âõ†', c.CGYY, 'ÂâçÂæÄ', c.CGGJ) -- Âá∫ÂõΩ
                   END    AS changeInfo,
               j.CJSJ     AS changeTime,
               CASE j.KJYDLXBS
                   WHEN 1 THEN x.YYZMWJDZ
                   WHEN 2 THEN x.YYZMWJDZ
                   WHEN 4 THEN z.SCWJDZ
                   WHEN 5 THEN NULL
                   WHEN 6 THEN NULL
                   WHEN 7 THEN NULL
                   END    AS proofMaterial
        FROM kjydjl j
                 JOIN ksxx ks ON j.KSH = ks.KSH
                 JOIN kjydlx l ON j.KJYDLXBS = l.KJYDLXBS
                 LEFT JOIN xfxjl x ON j.KJYDJLBS = x.KJYDJLBS
                 LEFT JOIN zxjl z ON j.KJYDJLBS = z.KJYDJLBS
                 LEFT JOIN lsjl ls ON j.KJYDJLBS = ls.KJYDJLBS
                 LEFT JOIN cgdj c ON j.KJYDJLBS = c.KJYDJLBS
        WHERE j.KSH = #{ksh}
          AND j.KJYDLXBS IN (1, 2, 4, 5, 6, 7) -- Âè™‰øùÁïôÊåáÂÆöÂºÇÂä®Á±ªÂûã
        ORDER BY j.CJSJ DESC
    </select>

    <select id="findKjydjlById" resultType="edu.qhjy.statuschange.domain.Kjydjl">
        SELECT *
        FROM kjydjl
        WHERE KJYDJLBS = #{kjydjlbs}
    </select>

    <update id="updateAuditInfo" parameterType="edu.qhjy.statuschange.domain.Kjydjl">
        UPDATE kjydjl
        SET SHJD  = #{shjd},  -- ÂÆ°Ê†∏Èò∂ÊÆµ
            SHZT  = #{shzt},  -- ÂÆ°Ê†∏Áä∂ÊÄÅ
            SHSJ  = #{shsj},  -- ÂÆ°Ê†∏Êó∂Èó¥
            SHRXM = #{shrxm}, -- ÂÆ°Ê†∏‰∫∫ÂßìÂêç
            SHYJ  = #{shyj}   -- ÂÆ°Ê†∏ÊÑèËßÅ
        WHERE KJYDJLBS = #{kjydjlbs}
    </update>

    <select id="findKshByKjydjlbs" resultType="java.lang.String">
        SELECT KSH
        FROM kjydjl
        WHERE KJYDJLBS = #{kjydjlbs}
    </select>

    <select id="findXfxjlByKjydjlbs" resultType="edu.qhjy.statuschange.domain.Xfxjl">
        SELECT *
        FROM xfxjl
        WHERE KJYDJLBS = #{kjydjlbs}
        ORDER BY XFXJLBS DESC
        LIMIT 1
    </select>

    <select id="findZxjlByKjydjlbs" resultType="edu.qhjy.statuschange.domain.Zxjl">
        SELECT *
        FROM zxjl
        WHERE KJYDJLBS = #{kjydjlbs}
        ORDER BY ZXJLBS DESC
        LIMIT 1
    </select>

    <select id="findXxbgjlByKjydjlbs" resultType="edu.qhjy.statuschange.domain.Xxbgjl">
        SELECT *
        FROM xxbgjl
        WHERE KJYDJLBS = #{kjydjlbs}
    </select>

    <select id="countPendingApplications" resultType="int">
        SELECT COUNT(*)
        FROM kjydjl
        WHERE KSH = #{ksh}
          AND KJYDLXBS = #{kjydlxbs}
          AND SHZT = 'ÂæÖÂÆ°Ê†∏'
    </select>

    <select id="findLatestEffectiveSuspensionOrResumption" resultType="edu.qhjy.statuschange.domain.Xfxjl">
        SELECT x.*
        FROM xfxjl x
                 JOIN kjydjl j ON x.KJYDJLBS = j.KJYDJLBS
        WHERE j.KSH = #{ksh}
          AND j.KJYDLXBS IN (1, 2) -- 1=‰ºëÂ≠¶, 2=Â§çÂ≠¶
          AND j.SHZT = 'ÈÄöËøá'      -- Âè™Êü•ËØ¢Â∑≤ÂÆ°Ê†∏ÈÄöËøáÁöÑ
        ORDER BY j.SHSJ DESC -- ÊåâÂÆ°Ê†∏Êó∂Èó¥ÂÄíÂ∫è
        LIMIT 1
    </select>

    <select id="findSchoolNameByBjbs" resultType="java.lang.String">
        SELECT xx.MC
        FROM bjxx bj
                 JOIN
             XYZDK xx ON bj.XXDM = xx.DM AND xx.JH = 'ZX'
        WHERE BJBS = #{bjbs}
    </select>

    <update id="setFxkshByKjydjlbs">
        UPDATE xfxjl
        SET FXXJH = #{fxksh},
            XXSC  = #{xxsc}
        WHERE KJYDJLBS = #{kjydjlbs}
    </update>

    <select id="findIfSchoolExistBySchoolName" resultType="int">
        SELECT COUNT(1)
        FROM XYZDK
        WHERE MC = #{xxmc}
          AND JH = 'ZX'
    </select>
</mapper>