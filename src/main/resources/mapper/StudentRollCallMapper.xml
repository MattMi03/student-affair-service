<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.qhjy.rollcall.mapper.StudentRollCallMapper">

    <!-- 学生考勤分页查询 -->
    <select id="findForPage" resultType="edu.qhjy.rollcall.vo.StudentRollCallListVO">
        SELECT
        s.XM AS xm,
        s.KSH AS ksh,
        s.SFZJH AS sfzjh,
        s.JB AS jb,
        s.BJMC AS bjmc,
        school.MC AS xxmc,
        kq.MC AS kqmc,
        szs.MC AS szsmc,
        kqjl.kqzt,
        kqjl.kqsj,
        kqjl.zqry
        FROM
        kqjl
        JOIN KSXX s ON kqjl.KSH = s.KSH
        JOIN XYZDK school ON s.XXDM = school.DM AND school.JH = 'ZX'    <!-- 学校 -->
        JOIN XYZDK kq ON s.XXDM LIKE kq.DM || '%' AND kq.JH = 'KD'       <!-- 考区 -->
        JOIN XYZDK szs ON s.XXDM LIKE szs.DM || '%' AND szs.JH = 'KQ'     <!-- 地市 -->
        <where>
            <if test="xxdm != null and xxdm != ''">
                AND school.DM = #{xxdm}
            </if>
            <if test="xm != null and xm != ''">
                AND s.XM LIKE CONCAT('%', #{xm}, '%')
            </if>
            <if test="sfzjh != null and sfzjh != ''">
                AND s.SFZJH = #{sfzjh}
            </if>
            <if test="jb != null">
                AND s.JB = #{jb}
            </if>
            <if test="bjbs != null">
                AND s.BJBS = #{bjbs}
            </if>
        </where>
        ORDER BY kqjl.kqsj DESC
    </select>

    <!-- 导出Excel使用的查询 -->
    <select id="findForPageForExcel" resultType="edu.qhjy.rollcall.vo.StudentRollCallListVO">
        SELECT
        s.XM AS xm,
        s.KSH AS ksh,
        s.SFZJH AS sfzjh,
        s.JB AS jb,
        s.BJMC AS bjmc,
        school.MC AS xxmc,
        kq.MC AS kqmc,
        szs.MC AS szsmc
        FROM
        XYZDK school
        LEFT JOIN KSXX s
        ON s.XXDM = school.DM AND school.JH = 'ZX'
        LEFT JOIN XYZDK kq
        ON s.XXDM LIKE kq.DM || '%' AND kq.JH = 'KD'
        LEFT JOIN XYZDK szs
        ON s.XXDM LIKE szs.DM || '%' AND szs.JH = 'KQ'
        <where>
            <if test="xxdm != null and xxdm != ''">
                AND school.DM = #{xxdm}
            </if>
            <if test="jb != null">
                AND s.JB = #{jb}
            </if>
            <if test="bjbs != null">
                AND s.BJBS = #{bjbs}
            </if>
        </where>
        ORDER BY school.DM, s.JB, s.BJMC
    </select>

    <!-- 批量插入 -->
    <insert id="batchInsert">
        INSERT INTO kqjl (ksh, kqzt, kqsj, zqry)
        VALUES
        <foreach collection="list" item="record" separator=",">
            (#{record.ksh}, #{record.kqzt}, #{record.kqsj}, #{record.zqry})
        </foreach>
    </insert>

    <!-- 查询已有学生学号 -->
    <select id="findExistingKshs" resultType="string" parameterType="list">
        SELECT KSH FROM KSXX
        WHERE KSH IN
        <foreach item="ksh" collection="list" open="(" separator="," close=")">
            #{ksh}
        </foreach>
    </select>

    <!-- 批量插入忽略重复 -->
    <insert id="batchInsertIgnoreDuplicates" parameterType="list">
        INSERT INTO kqjl (ksh, kqzt, kqsj, zqry)
        SELECT ksh, kqzt, kqsj, zqry
        FROM (
        <foreach collection="list" item="record" separator="UNION ALL">
            SELECT
            #{record.ksh} AS ksh,
            #{record.kqzt} AS kqzt,
            #{record.kqsj} AS kqsj,
            #{record.zqry} AS zqry
        </foreach>
        ) tmp
        WHERE NOT EXISTS (
        SELECT 1 FROM kqjl
        WHERE ksh = tmp.ksh
        AND TRUNC(kqsj) = TRUNC(tmp.kqsj)
        )
    </insert>

</mapper>